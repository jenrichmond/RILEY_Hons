---
title: "9_cheek_analysis"
output: html_document
---
# load packages
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(lme4)
library(lmerTest)
library(broom.mixed)
library(pixiedust)
library(beepr)
```

# read in data 
```{r}
df <- read_csv(here("data", "adult_child_combined", "zdiff_binscreened.csv"))
```
# fix data types

The emotion variable below is numbers so not sure how the emotion %in% c(happy, angry) was working. Add emo variable with emotion labels
```{r}
df$emotion <- as.factor(df$emotion)

levels(df$emotion)

df <- df %>%
  mutate(emo = case_when(emotion == 121 ~ "happy", 
                              emotion == 323 ~ "angry", 
                              emotion == 424 ~ "fear", 
                              emotion == 525 ~ "sad", 
                              emotion == 131 ~ "happy", 
                              emotion == 232 ~ "angry", 
                              emotion == 434 ~ "fear", 
                              emotion == 535 ~ "sad"))

df <- df %>% mutate_if(is.character, as.factor)

glimpse(df)
```

# CHEEK happy-angry child

### Make cheek HA child df 

just happy/angry child face for cheek

```{r}
HA_child_cheek <- df %>%
  filter(emo %in% c("happy", "angry")) %>%
  filter(muscle == "cheek") %>%
  filter(model == "child") %>%
  arrange(pp_no, emotion, trial, bin)

glimpse(HA_child_cheek)

```

Fix factor levels

```{r}

HA_child_cheek$emo <- fct_relevel(HA_child_cheek$emo, c("happy", "angry", "fear", "sad"))

levels(HA_child_cheek$emo)



HA_child_cheek$bin <- fct_relevel(HA_child_cheek$bin, c("diff_bin1", "diff_bin2", "diff_bin3", "diff_bin4", "diff_bin5", "diff_bin6", "diff_bin7", "diff_bin8", "diff_bin9", "diff_bin10"))

levels(HA_child_cheek$bin)
```

## fit model 1 

This is the model structure we will use to check assumptions. Include all predicted fixed effects and simplest random effect structure (just intercepts for participant). In all likelihood this model with zscores as DV will not meet assumptions and we will need to transform data. 

```{r}
child_cheek_emoZ <- lmer(zdiff ~ emo + bin + emo*bin + (1|pp_no), data = HA_child_cheek, REML = FALSE)

```


### check assumptions
```{r}
plot(child_cheek_emoZ)

qqnorm(resid(child_cheek_emoZ))
qqline(resid(child_cheek_emoZ))
```

As suscepted, need to transform to correct normality. 

### compute log_modulus

NOTE: this first log mod calc is WRONG, uses + instead of *

```{r}
HA_child_cheek <- HA_child_cheek %>%
  mutate(log_modulus = sign(zdiff) + log(1+abs(zdiff)))
```

### fit model again

```{r}
child_cheek_emo_log <- lmer(log_modulus ~ emotion + bin + emotion*bin + (1|pp_no), data = HA_child_cheek, REML = FALSE)

```

### check assumptions again
```{r}
plot(child_cheek_emo_log)

qqnorm(resid(child_cheek_emo_log))
qqline(resid(child_cheek_emo_log))
```

## YIKES something not right 

*WHAT* that looks WAY worse.... what is going on here...

Is that log_mod doing what we think?? How to log modulus here.... https://blogs.sas.com/content/iml/2014/07/14/log-transformation-of-pos-neg.html

RILEY- it is * log not +

### compute new log mod

```{r}
HA_child_cheek <- HA_child_cheek %>%
  mutate(log_modulus_new = sign(zdiff) * log(1+abs(zdiff)))
```

### try fit model again

```{r}
child_cheek_emo_log_new <- lmer(log_modulus_new ~ emotion + bin + emotion*bin + (1|pp_no), data = HA_child_cheek, REML = FALSE)

```

### check assumptions again
```{r}
plot(child_cheek_emo_log_new)

qqnorm(resid(child_cheek_emo_log_new))
qqline(resid(child_cheek_emo_log_new))
```


Better but not great. 

*JENNY CODE CHECK UP TO HERE*


# BUILD model comparisons

What would the model fit look like if we built it from the ground up, adding each main effect then interaction with intercepts for particiapnt and slopes for main effects. 

```{r}
levels(HA_child_cheek$emo)
```


### model 1 

just main effect of emotion and slope for emotion 

```{r}
child_cheek_emo <- lmer(log_modulus_new ~ emo + (1 + emo|pp_no), data = HA_child_cheek, REML = FALSE)

beep(1)
```

## model 2

just main effect of emotion and bin, and slope for emotion 
```{r}
child_cheek_emo_bin <- lmer(log_modulus_new ~ emo + bin + (1 + emo|pp_no), data = HA_child_cheek, REML = FALSE)

beep(2)
```

## model 3

main effect of emotion and bin and emotion*bin, and slope for emotion (slope for bin doesnt converge)

```{r}
child_cheek_emo_bin_interaction <- lmer(log_modulus_new ~ emo + bin + emo*bin + (1 + emo|pp_no), data = HA_child_cheek, REML = FALSE)

beep(3)
```


# TEST for best fit 

AIC decreases (i.e. better fit) from model with just main effect of emotion to model with emotion and bin, but then goes back up again when the interaction is added. 

```{r}
AIC(child_cheek_emo)
AIC(child_cheek_emo_bin)
AIC(child_cheek_emo_bin_interaction)

```

## likelihood ratio tests

Is the model with main effects of emotion and bin sig better fit than model with just effect of emotion? YES

```{r}
anova(child_cheek_emo, child_cheek_emo_bin)
```

Is model with with interaction, better fit than model with just main effects? NO 
```{r}
anova(child_cheek_emo_bin, child_cheek_emo_bin_interaction)
```


#get confidence intervals
```{r}
confint.merMod(child_cheek_emo_bin_interaction, level = 0.95)
```

```{r}
really_nice_table <- dust(child_cheek_emo_bin_interaction) %>%
  sprinkle(col = 4:7, round = 3, pad = 15, halign = "center", valign = "middle") %>%
  sprinkle(col = 8, fn = quote(pvalString(value)), halign = "center", valign = "middle") %>%
  sprinkle_colnames(term = "Term", 
                    estimate = "Estimate", 
                    std.error = "SE",
                    statistic = "t statistic", 
                    p.value = "P-value")  %>%
  sprinkle(bg_pattern_by = "rows") %>%
    sprinkle_print_method("html") 

really_nice_table
```

```{r}
anova(child_cheek_emo_bin_interaction)
```


# Cheek happy-angry adult

```{r}
HA_adult_cheek <- df %>%
  filter(emo %in% c("happy", "angry")) %>%
  filter(muscle == "cheek") %>%
  filter(model == "adult") %>%
  arrange(pp_no, emotion, trial, bin)

glimpse(HA_adult_cheek)

```



#fix factor levels 

```{r}
HA_adult_cheek$emo <- fct_relevel(HA_adult_cheek$emo, c("happy", "angry", "fear", "sad"))

levels(HA_adult_cheek$emo)



HA_adult_cheek$bin <- fct_relevel(HA_adult_cheek$bin, c("diff_bin1", "diff_bin2", "diff_bin3", "diff_bin4", "diff_bin5", "diff_bin6", "diff_bin7", "diff_bin8", "diff_bin9", "diff_bin10"))

levels(HA_adult_cheek$bin)
```



#fit model 1 - this is the model we use to check assumptions
```{r}
adult_cheek_emoZ <- lmer(zdiff ~ emo + bin + emo*bin + (1|pp_no), data = HA_child_cheek, REML = FALSE)
```


```{r}
plot(adult_cheek_emoZ)

qqnorm(resid(adult_cheek_emoZ))
qqline(resid(adult_cheek_emoZ))
```



need to transform to correct normality. 

### compute log_modulus

```{r}
HA_adult_cheek <- HA_adult_cheek %>%
  mutate(log_modulus = sign(zdiff) + log(1+abs(zdiff)))
```


### fit model again

```{r}
adult_cheek_emo_log <- lmer(log_modulus ~ emotion + bin + emotion*bin + (1|pp_no), data = HA_adult_cheek, REML = FALSE)

```

### check assumptions again
```{r}
plot(adult_cheek_emo_log)

qqnorm(resid(adult_cheek_emo_log))
qqline(resid(adult_cheek_emo_log))
```
#this is much worse 

### compute new log mod

```{r}
HA_adult_cheek <- HA_adult_cheek %>%
  mutate(log_modulus_new = sign(zdiff) * log(1+abs(zdiff)))
```

### try fit model again

```{r}
adult_cheek_emo_log_new <- lmer(log_modulus_new ~ emotion + bin + emotion*bin + (1|pp_no), data = HA_adult_cheek, REML = FALSE)

```

### check assumptions again
```{r}
plot(adult_cheek_emo_log_new)

qqnorm(resid(adult_cheek_emo_log_new))
qqline(resid(adult_cheek_emo_log_new))
```

# BUILD model comparisons

What would the model fit look like if we built it from the ground up, adding each main effect then interaction with intercepts for particiapnt and slopes for main effects. 

```{r}
levels(HA_adult_cheek$emo)
```


### model 1 

just main effect of emotion and slope for emotion 

```{r}
adult_cheek_emo <- lmer(log_modulus_new ~ emo + (1 + emo|pp_no), data = HA_adult_cheek, REML = FALSE)

beep(1)
```

## model 2

just main effect of emotion and bin, and slope for emotion 
```{r}
adult_cheek_emo_bin <- lmer(log_modulus_new ~ emo + bin + (1 + emo|pp_no), data = HA_adult_cheek, REML = FALSE)

beep(2)
```

## model 3

main effect of emotion and bin and emotion*bin, and slope for emotion (slope for bin doesnt converge)

```{r}
adult_cheek_emo_bin_interaction <- lmer(log_modulus_new ~ emo + bin + emo*bin + (1 + emo|pp_no), data = HA_adult_cheek, REML = FALSE)

beep(3)
```


# TEST for best fit 

AIC decreases (i.e. better fit) from model with just main effect of emotion to model with emotion and bin, and then stays the same when the interaction is added. 

```{r}
AIC(adult_cheek_emo)
AIC(adult_cheek_emo_bin)
AIC(adult_cheek_emo_bin_interaction)
```

## likelihood ratio tests

Is the model with main effects of emotion and bin sig better fit than model with just effect of emotion? YES

```{r}
anova(adult_cheek_emo, adult_cheek_emo_bin)
```

Is model with just main effects better than the model with interactions? YES
```{r}
anova(adult_cheek_emo_bin, adult_cheek_emo_bin_interaction)
```

```{r}
summary(adult_cheek_emo_bin)

anova(adult_cheek_emo_bin)
```

```{r}
confint.merMod(adult_cheek_emo_bin_interaction, level = 0.95)
```

```{r}
really_nice_table <- dust(adult_cheek_emo_bin_interaction) %>%
  sprinkle(col = 4:7, round = 3, pad = 15, halign = "center", valign = "middle") %>%
  sprinkle(col = 8, fn = quote(pvalString(value)), halign = "center", valign = "middle") %>%
  sprinkle_colnames(term = "Term", 
                    estimate = "Estimate", 
                    std.error = "SE",
                    statistic = "t statistic", 
                    p.value = "P-value")  %>%
  sprinkle(bg_pattern_by = "rows") %>%
    sprinkle_print_method("html") 

really_nice_table
```


```{r}
anova(adult_cheek_emo_bin_interaction)
```



```{r}
df <- df %>%
  write_csv(here("data", "adult_child_combined", "zdiff_binscreened2.csv"))

```






